# PyInstaller æ‰“åŒ…æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨PyInstallerå°†Pan115 Scraperæ‰“åŒ…ä¸ºç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

## ğŸ”§ å·²è§£å†³çš„é—®é¢˜

### 1. èµ„æºè·¯å¾„é—®é¢˜
**é—®é¢˜**: PyInstalleræ‰“åŒ…åï¼ŒFlaskæ— æ³•æ‰¾åˆ°templateså’Œstaticæ–‡ä»¶å¤¹ã€‚

**è§£å†³æ–¹æ¡ˆ**: 
- åœ¨`app.py`ä¸­æ·»åŠ äº†`get_resource_path()`å‡½æ•°
- åŠ¨æ€æ£€æµ‹æ˜¯å¦åœ¨PyInstallerç¯å¢ƒä¸­è¿è¡Œ
- æ­£ç¡®è®¾ç½®Flaskçš„`template_folder`å’Œ`static_folder`å‚æ•°

```python
def get_resource_path(relative_path):
    """è·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œå…¼å®¹PyInstalleræ‰“åŒ…"""
    try:
        base_path = sys._MEIPASS  # PyInstallerä¸´æ—¶ç›®å½•
    except AttributeError:
        base_path = os.path.dirname(os.path.abspath(__file__))
    return os.path.join(base_path, relative_path)
```

### 2. é…ç½®æ–‡ä»¶è·¯å¾„é—®é¢˜
**é—®é¢˜**: é…ç½®æ–‡ä»¶`config.json`åœ¨æ‰“åŒ…åæ— æ³•æ­£ç¡®è¯»å†™ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- é…ç½®æ–‡ä»¶åº”è¯¥æ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶åŒç›®å½•ï¼Œè€Œä¸æ˜¯ä¸´æ—¶ç›®å½•
- æ·»åŠ äº†`get_config_path()`å‡½æ•°æ¥åŠ¨æ€è·å–é…ç½®æ–‡ä»¶è·¯å¾„

```python
def get_config_path():
    """è·å–é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¼˜å…ˆä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶åŒç›®å½•"""
    try:
        if hasattr(sys, '_MEIPASS'):
            exe_dir = os.path.dirname(sys.executable)
            return os.path.join(exe_dir, 'config.json')
        else:
            return os.path.join(os.path.dirname(os.path.abspath(__file__)), 'config.json')
    except:
        return 'config.json'
```

### 3. æ—¥å¿—æ–‡ä»¶è·¯å¾„é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**: æ—¥å¿—æ–‡ä»¶ä¹Ÿåº”è¯¥æ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶åŒç›®å½•ã€‚

### 4. å¤‡ä»½æ–‡ä»¶è·¯å¾„é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**: é‡å‘½åå¤‡ä»½æ–‡ä»¶åŒæ ·éœ€è¦æ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶åŒç›®å½•ã€‚

### 5. éšè—å¯¼å…¥é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**: åœ¨`pan115-scraper.spec`ä¸­æ·»åŠ äº†å®Œæ•´çš„éšè—å¯¼å…¥åˆ—è¡¨ï¼ŒåŒ…æ‹¬ï¼š
- åŠ å¯†ç›¸å…³æ¨¡å—
- FlaskåŠå…¶ä¾èµ–
- ç½‘ç»œè¯·æ±‚ç›¸å…³æ¨¡å—
- æ ‡å‡†åº“æ¨¡å—

## ğŸ“ æ–‡ä»¶ç»“æ„

```
pan115-scraper/
â”œâ”€â”€ app.py                    # ä¸»åº”ç”¨æ–‡ä»¶ï¼ˆå·²ä¿®å¤è·¯å¾„é—®é¢˜ï¼‰
â”œâ”€â”€ pan115-scraper.spec      # PyInstalleré…ç½®æ–‡ä»¶
â”œâ”€â”€ hook-app.py              # PyInstaller hookæ–‡ä»¶
â”œâ”€â”€ build.sh                 # Linux/macOSæ„å»ºè„šæœ¬
â”œâ”€â”€ build-windows.ps1        # Windowsæ„å»ºè„šæœ¬
â”œâ”€â”€ build.bat                # Windowsæ‰¹å¤„ç†æ„å»ºè„šæœ¬
â”œâ”€â”€ test_build.py            # æ„å»ºæµ‹è¯•è„šæœ¬
â”œâ”€â”€ start_packaged.py        # æ‰“åŒ…ç‰ˆæœ¬å¯åŠ¨è„šæœ¬
â”œâ”€â”€ templates/               # HTMLæ¨¡æ¿
â”œâ”€â”€ static/                  # é™æ€èµ„æº
â”œâ”€â”€ config.json.example      # é…ç½®æ–‡ä»¶ç¤ºä¾‹
â””â”€â”€ dist/                    # æ„å»ºè¾“å‡ºç›®å½•
    â”œâ”€â”€ pan115-scraper-win.exe    # Windowså¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ pan115-scraper-mac        # macOSå¯æ‰§è¡Œæ–‡ä»¶
    â””â”€â”€ pan115-scraper-linux      # Linuxå¯æ‰§è¡Œæ–‡ä»¶
```

## ğŸš€ æ„å»ºæ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨æ„å»ºè„šæœ¬

#### Windows
```powershell
# PowerShellè„šæœ¬
.\build-windows.ps1

# æˆ–æ‰¹å¤„ç†è„šæœ¬
.\build.bat
```

#### Linux/macOS
```bash
# è®¾ç½®æ‰§è¡Œæƒé™
chmod +x build.sh

# è¿è¡Œæ„å»º
./build.sh
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ„å»º

1. **å®‰è£…ä¾èµ–**
```bash
pip install pyinstaller
pip install -r requirements.txt
```

2. **è¿è¡ŒPyInstaller**
```bash
pyinstaller pan115-scraper.spec
```

3. **æµ‹è¯•æ„å»ºç»“æœ**
```bash
python test_build.py
```

## ğŸ§ª æµ‹è¯•æ‰“åŒ…ç»“æœ

### è‡ªåŠ¨æµ‹è¯•
```bash
python test_build.py
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# å¯åŠ¨æ‰“åŒ…åçš„åº”ç”¨
python start_packaged.py

# æˆ–ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
./dist/pan115-scraper-mac  # macOS
./dist/pan115-scraper-linux  # Linux
.\dist\pan115-scraper-win.exe  # Windows
```

## âš™ï¸ é…ç½®è¯´æ˜

### PyInstaller Specæ–‡ä»¶å…³é”®é…ç½®

1. **æ•°æ®æ–‡ä»¶åŒ…å«**
```python
datas=[
    ('templates', 'templates'),
    ('static', 'static'),
    ('config.json.example', '.'),
    ('README.md', '.'),
    ('LICENSE', '.'),
],
```

2. **éšè—å¯¼å…¥**
- åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„Pythonæ¨¡å—
- ç‰¹åˆ«æ³¨æ„åŠ å¯†ã€ç½‘ç»œè¯·æ±‚ã€Flaskç›¸å…³æ¨¡å—

3. **æ’é™¤é¡¹**
- æ’é™¤äº†ä¸å¿…è¦çš„å¤§å‹åº“ï¼ˆå¦‚numpyã€matplotlibç­‰ï¼‰
- å‡å°å¯æ‰§è¡Œæ–‡ä»¶å¤§å°

4. **ä¼˜åŒ–é€‰é¡¹**
- å¯ç”¨UPXå‹ç¼©
- ä¼˜åŒ–çº§åˆ«è®¾ä¸º1

## ğŸ› å¸¸è§é—®é¢˜

### 1. æ¨¡æ¿æ–‡ä»¶æ‰¾ä¸åˆ°
**é”™è¯¯**: `TemplateNotFound: index.html`

**è§£å†³**: ç¡®ä¿`app.py`ä¸­æ­£ç¡®è®¾ç½®äº†æ¨¡æ¿è·¯å¾„ï¼Œå¹¶ä¸”specæ–‡ä»¶åŒ…å«äº†templatesç›®å½•ã€‚

### 2. é™æ€æ–‡ä»¶404
**é”™è¯¯**: CSS/JSæ–‡ä»¶æ— æ³•åŠ è½½

**è§£å†³**: ç¡®ä¿Flaskæ­£ç¡®è®¾ç½®äº†static_folderè·¯å¾„ã€‚

### 3. é…ç½®æ–‡ä»¶æ— æ³•ä¿å­˜
**é”™è¯¯**: é…ç½®æ›´æ”¹åé‡å¯ä¸¢å¤±

**è§£å†³**: ç¡®ä¿é…ç½®æ–‡ä»¶è·¯å¾„æŒ‡å‘å¯æ‰§è¡Œæ–‡ä»¶åŒç›®å½•ï¼Œè€Œä¸æ˜¯ä¸´æ—¶ç›®å½•ã€‚

### 4. å¯¼å…¥é”™è¯¯
**é”™è¯¯**: `ModuleNotFoundError`

**è§£å†³**: åœ¨specæ–‡ä»¶çš„hiddenimportsä¸­æ·»åŠ ç¼ºå¤±çš„æ¨¡å—ã€‚

### 5. å¯æ‰§è¡Œæ–‡ä»¶è¿‡å¤§
**è§£å†³**: 
- æ£€æŸ¥excludesåˆ—è¡¨ï¼Œæ’é™¤ä¸å¿…è¦çš„åº“
- å¯ç”¨UPXå‹ç¼©
- ä½¿ç”¨`--onefile`é€‰é¡¹

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å‡å°æ–‡ä»¶å¤§å°**
   - æ’é™¤ä¸å¿…è¦çš„åº“
   - å¯ç”¨UPXå‹ç¼©
   - ä¼˜åŒ–å¯¼å…¥

2. **æé«˜å¯åŠ¨é€Ÿåº¦**
   - å‡å°‘éšè—å¯¼å…¥
   - ä¼˜åŒ–ä»£ç ç»“æ„
   - ä½¿ç”¨lazy loading

3. **å†…å­˜ä¼˜åŒ–**
   - é¿å…å…¨å±€å˜é‡
   - åŠæ—¶é‡Šæ”¾èµ„æº
   - ä½¿ç”¨ç”Ÿæˆå™¨

## ğŸ” è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼**
```python
# åœ¨specæ–‡ä»¶ä¸­è®¾ç½®
debug=True
```

2. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
```bash
pyinstaller --log-level DEBUG pan115-scraper.spec
```

3. **åˆ†æä¾èµ–**
```bash
pyi-archive_viewer dist/pan115-scraper-mac
```

4. **æµ‹è¯•å¯¼å…¥**
```python
# åœ¨Pythonä¸­æµ‹è¯•æ¨¡å—å¯¼å…¥
import sys
sys.path.insert(0, 'dist/pan115-scraper-mac')
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è·¯å¾„åˆ†éš”ç¬¦**: ä½¿ç”¨`os.path.join()`è€Œä¸æ˜¯ç¡¬ç¼–ç è·¯å¾„åˆ†éš”ç¬¦
2. **ç¼–ç é—®é¢˜**: ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨UTF-8ç¼–ç 
3. **æƒé™é—®é¢˜**: ç¡®ä¿å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
4. **é˜²ç—…æ¯’è½¯ä»¶**: æŸäº›é˜²ç—…æ¯’è½¯ä»¶å¯èƒ½è¯¯æŠ¥ï¼Œéœ€è¦æ·»åŠ ç™½åå•
5. **ä¾èµ–ç‰ˆæœ¬**: ç¡®ä¿æ‰€æœ‰ä¾èµ–ç‰ˆæœ¬å…¼å®¹

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬æ§åˆ¶**: ä¸è¦å°†distç›®å½•æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
2. **è‡ªåŠ¨åŒ–æ„å»º**: ä½¿ç”¨CI/CDè‡ªåŠ¨åŒ–æ„å»ºè¿‡ç¨‹
3. **æµ‹è¯•è¦†ç›–**: æ¯æ¬¡æ„å»ºåéƒ½è¦è¿›è¡Œå®Œæ•´æµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°æ„å»ºæ–‡æ¡£å’Œè¯´æ˜
5. **ç”¨æˆ·åé¦ˆ**: æ”¶é›†ç”¨æˆ·åé¦ˆï¼ŒæŒç»­æ”¹è¿›æ‰“åŒ…è´¨é‡
